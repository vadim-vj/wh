- <https://postgrespro.ru/docs/postgresql/12/index>
- <https://www.postgresql.org/docs/13/index.html>
- <https://www.postgresql.org/docs/13/source.html>
- <https://www.sqlstyle.guide/ru/>
- <https://planet.postgresql.org>
- <https://wiki.postgresql.org/wiki/Main_Page>

#### Лузанов П. и др., Postgres: первое знакомство
<https://postgrespro.ru/education/books/introbook>

---

# SQL [lang]

---
> Сохраняется ли порядок добавления строк в таблицу?


Нет, строки неупорядочены, хранятся не обязательно в порядке добавления

---
> Как называются целый, логический и строковый типы?

`integer`, `boolean` (`true`/`false`) и `text` соответственно

---
> Какой литерал у *неопределенного* значения?

`NULL`

---
> Какой синтаксис у описания столбца в `CREATE TABLE`?

`<имя> <тип>[ <PRIMARY KEY>]`:

```sql
CREATE TABLE courses(
    c_no text PRIMARY KEY,
    title text,
    hours integer
);
```

---
> Какие ограничения для данных в столбце `PRIMARY KEY`?

- значения должны быть уникальны
- неопределенные (`NULL`) значения не допускаются

---
> Какой командой лучше массово загружать данные в таблицы?

`COPY`, не `INSERT`

---
> Какой общий синтаксис у `INSERT`?

```sql
INSERT INTO <table-name> (<column-names>) VALUES (<values>)
INSERT INTO students (s_id, name, start_year) VALUES (1451,'Анна', 2014)
```

---
> Что по умолчанию выводит `INSERT`?

Цифры - это `oid` (всегда `0`) + количество вставленных строк:

```shell
INSERT 0 3
```

Когда-то поддерживалось `WITH OID` при создании таблиц, и первое число могло быть не нулем, но больше это не доступно

Если `INSERT` содержит инструкцию `RETURNING`, то вывод будет таким, как указано в ней

---
> Как в `CREATE TABLE` задать первичный ключ из нескольких столбцов?

После описания всех столбцов, используя ключевое слово `CONSTRAINT`:

```sql
  ...
  score integer,
  CONSTRAINT pk PRIMARY KEY(s_id, c_no)
);
```

---
> Какой синтаксис у объявления внешнего ключа вместе со столбцом?

Через ключевое слово `REFERENCES` и ссылку вида `<таблица>(<столбец>)`:

```sql
CREATE TABLE exams(
  s_id integer REFERENCES students(s_id),
  ...
```

---
> Как именуются столбцы в выводе `SELECT`-а?

- используется алиас (`AS <alias>`)
- если `AS` не указан - то имя самого столбца
- `?column?` - если имя неопределено (напр., `SELECT 1` или столбец вычисляемый)

---
> К какой части `SELECT` относится `DISCTINCT`?

К ключевому слову, т.е. ко всей выборке, а не к отдельному столбцу:

```sql
SELECT DISTINCT name, start_year FROM students;
-- SELECT name, DISTINCT start_year FROM students; /* syntax error */
```

---
> Какие комментарии есть в PostgreSQL?

Два дефиса и стандартный блочный:

```sql
-- Single-line comment
/*
 Multi-line comment
*/
```

---
> Сколько строк будет содержать результат `SELECT` без `FROM`?

Всего одну:

```sql
SELECT 2+2 AS result;
```

```shell
 result
--------
      4
(1 row)
```

---
> При каких результатах сравнения в `FROM` строка попадет в результат `SELECT`-а?

Если сравнение истинно. Не попадет, если сравнение ложно или *не определено* (напр, сравнение с `NULL`)

---
> В каких случаях результат операции не *определен*?

Все связаны с неопределнным значением `NULL`:

- результат сравнения чего угодно с `NULL` не определен
- результат логическиз операций с `NULL`, как правило, не определен


Как правило, это важно во `FROM` - строки, для которых результат сравнения не определен, в результат `SELECT`-а не попадают

---
> В каких случая логические операции с `NULL` всё же возвращают определенные значения?

Их два

```sql
true OR NULL = true
false AND NULL = false
```

---
> Какой синтаксис у операторов "равно" и "не равно"?

Одинарное равно и две формы для "не равно":

```sql
/* equals */
=
/* not equals */
<>
!=
```

---
> Какими способами можно получить прямое (декартово) произведение таблиц?

С точки зрения СУБД обе формы эквивалентны:

```sql
FROM t1, t2 WHERE t1.id = t2.id
FROM t1 JOIN t2 ON t1.id = t2.id
```

Выборку без ограничивающего условия можно получить только первым способом

---
> Почему `LEFT JOIN` называется "левый"?

В выборку добавляются строки из левой таблицы даже такие, для которых не нашлось пары в правой

---
> На каком этапе выполняется `WHERE` в запросах с `JOIN`-ами? Какие подводные?

Условие в `WHERE` выполняется *после* `JOIN`-а, применяется к уже готовому соединению. Поэтому, для `LEFT JOIN` возможна ситуация когда столбцы правой таблицы окажутся равными `NULL`, и сравнение с ними в `WHERE` не сработает

---
> В каких частях запроса можно использовать подзапросы (вложенный `SELECT`)?

Зависит от того, сколько строк такой подзапрос возвращает:

- если одну или меньше, то такой подзапрос называется *скалярным*, и его можно использовать как единственное значение, в том числе в списке столбцов для выборки или в условиях `WHERE`
- если большой одной строки, то в качестве источника ("таблицы") в `FROM`/`JOIN`, или также в `WHERE`, но только с операторами принадлежности существования, вроде `[NOT] IN`/`[NOT] EXISTS`

---
> Какое значение используется в качестве результата скалярного подзапроса, не возвращающего ни одной строки?

Неопределенное, `NULL`:

```sql
SELECT c1, (SELECT ...) as c2 FROM ...
```

```shell
  c1  | c2 
------+----
 some | 
(1 row)
```

---
> Как можно преобразовать скалярный подзапрос, используемый в качестве значения в столбце?

В `LEFT JOIN`

Соединение должно быть именно внешнее: скалярный подзапрос в списке столбцов `SELECT`-а возвращает `NULL`, если для него не найдено ни одной строки; для `INNER JOIN` же возврат неопределнного значения невозможен

---
> Можно ли в подзапросе ссылаться на таблицу из внешнего `SELECT`-а?

Да, вполне:

```sql
SELECT name, (SELECT score FROM exams WHERE exams.s_id = students.s_id) FROM students;
```

---
> Как указываются алиасы имен столбцов/таблиц?

`AS` при этом не обязательно:

```sql
SELECT name AS n FROM students AS s;
SELECT name n FROM students s;
```

---
> Где в `ORDER BY` можно указывать `ASC`/`DESC`?

После каждого ключа, не обязательно один на всё выражение:

```sql
SELECT * FROM students ORDER BY name ASC, start_year DESC
```

---
> Каков по умолчанию порядок сортировки в `ORDER BY`?

```sql
ASC
```

---
> Где в составных запросах имеет смысл располагать `ORDER BY`?

Только в конце основного запроса, перед получением результата. В подзапросах она обычно бесполезна

---
> Что делает `GROUP BY`?

Разбивает результат выборки на группы, на основе указанного в `GROUP BY` поля/выражения

---
> Какие агрегатные функции дают количество записей и среднее значение?


```sql
count(<field>|*)
avg(<field>)
```

---
> В каком порядке применяются условия фильтрации `WHERE` и `HAVING` в запросах с группировкой?

- сначала, до группировки, применяется `WHERE` - там можно использовать только столбцы исходных таблиц
- группировка `GROUP BY`
- потом, после группировки, применяется `HAVING` - там уже можно использовать столбцы таблицы-результата

---
> В каких условиях фильтрации можно использовать агрегатные функции?

Только в `HAVING`, в `WHERE` выдаст ошибку `aggregate functions are not allowed in WHERE`

---
> Какой общий синтаксис у `UPDATE` и `DELETE`?

```sql
UPDATE courses SET hours = hours * 2 WHERE c_no = 'CS301'
DELETE FROM exams WHERE score < 5
```

Обе команды выводят количество измененных/удаленных записей:

```shell
UPDATE 1
DELETE 1
```

---
> Как запретить неопределенные значения в столбце?

При создании таблицы, после типа столбца, указать `NOT NULL`:

```sql
CREATE TABLE groups(
  monitor integer NOT NULL
)
```

---
> Как добавить поле в таблицу?

Спецификация столбца такая же, как при создании таблицы:

```sql
ALTER TABLE students ADD g_no text REFERENCES groups(g_no)
```

---
> Что такое *транзакция*?

Логически неделимая единица работы

Например, транзакции могут быть использованы для обновления логически связанных таблиц, чтобы между последовательностью операций обновления не терялась целостность данных

---
> Как вставить в таблицу данные из результатов выборки (из другой таблицы)?

Вместо `VALUES` напрямую указать `SELECT`:

```sql
INSERT INTO groups(g_no, monitor)
SELECT'A-101', s_id FROM students WHERE name ='Анна';
```

---
> Какие команды начинают, завершают или откатывают транзакцию?

```sql
BEGIN
...
COMMIT
ROLLBACK
```

---
> Какие есть свойства у транзакций?

- *атомарность* - между командами `BEGIN` и `COMMIT` выполняются либо все команды, либо ни одной
- *согласованность* - данные в конце транзакции должны удовлетворять всем ограничениям (могут ли не удовлетворять внутри транзакции?)
- *изоляция* - параллельные процессы не видят изменений до окончания транзакции,им недоступны еще не согласованные данные. Доступ до базы при этом во время транзакции не блокируется
- *долговечность* - зафиксированные данные не пропадут даже в случае сбоя


---
> Один клиентский процесс `psql` начал (но еще не завершил) транзакцию, и записал несколько строк в таблицу. Что выдаст `SELECT` на этой таблице для текущего и параллельного процессов?

- выборка в текущем процессе (с открытой транзакцией, после `BEGIN`) выдаст все вставленные строки
- выборка в параллельном процессе даст пустой результат: до завершения транзакции первым процессом (до `COMMIT` в первом процессе) результаты этой транзакции никому не доступны

---

# Примеры кода [code]

---
> Различаются ли результаты вызова этих двух агрегатных функций?
> 
> ```sql
> count(*)
> count(DISTINCT id)
> ```

Да, различаются. Например, на таблице вида

```shell
  id 
------
 1451
 1556
 1451
 1432
(4 rows)
```

запрос

```sql
SELECT count(*), count(DISTINCT s_id) FROM ...
```

выдаст

```shell
 count | count 
-------+-------
     4 |     3
```

---
> В чем принципиально различие?
> 
> ```sql
> LEFT JOIN exams ON students.s_id = exams.s_id AND exams.c_no = 'CS305';
> LEFT JOIN exams ON students.s_id = exams.s_id WHERE exams.c_no = 'CS305';
> ```

В `WHERE` стоит операция сравнения, а она не определена при сравнении с `NULL`. Так как `WHERE` выполняется последним, а `LEFT JOIN exams` может привести к появлению `NULL`-значений, проверка в `WHERE` отсечет значения, для которых при соединении не нашлось пары

То есть первый вариант дает более "широкий" результат, а второй отсекает все `c_no = NULL`

---
> Как можно получить текущие дату и время?

Функция `now()`:

```sql
SELECT now()
```

```shell
              now              
-------------------------------
 2020-06-14 06:16:56.282864+04
(1 row)
```

---
> Как называется Python-модуль для соединения с Postgres-ом?

Устанавливается apt-ом по умолчанию, идет в стандартной поставке:

```shell
psycopg2
```

Версия 2 поддерживает массовую многопоточность и асинхронность

---
> Как через `python3-psycopg2` работать с базой?

Пять шагов:

```python
# 1. Подключение
conn = psycopg2.connect(
    database='appdb',
    user='app',
    ...
)
# 2. Получение курсора
cur = conn.cursor()
# 3. Выполнение запроса
cur.execute('SELECT * FROM greeting')
# 4. Получение списка кортежей записей
for row in cur[.fetchall()]:
    print row[0]
# 5. Закрытие соединения
conn.close()
```

---
> Какие есть 4 оператора полнотекстового поиска?

```sql
-- Из SQL-стандарта
LIKE -- он же @@
-- Специфичные для PostrgeSQL
ILIKE -- LIKE, не чувствительный к регистру
~
~*
```

---
> Как вставить JSON в поле таблицы?

- поле должно быть объявлено с типом `json`
- данные вставляются стандартно, через `INSERT`, как строка (в одинарных кавычках) валидного JSON-а

---
> Как обратиться к ключу верхнего уровня в поле с типом `json`?

Через оператор `->>`:

```sql
WHERE s.s_id = sd.s_id
AND sd.details ->> 'достоинства' IS NOT NULL
AND sd.details ->> 'достоинства' != 'отсутствуют'
```

---
> Как обратиться к ключу произвольного уровня в поле с типом `json`?

Через оператор `#>`, указав в фигурных сковках последовательность ключей или индексов:

```sql
'{"a": {"b": ["foo","bar"]}}'::json #> '{a,b,1}' -- "bar"
```

---
> В чем отличия `jsonb` от `json`?

Это бинарный формат хранения:

- данные в нем хранятся плотно упакованными (экономится место) и поиск по нему работает быстрее
- для преобразования в него нужно вызывать функцию `to_jsonb('...')`
- он не сохраняет порядок ключей в JSON
- для него другой набор операторов

---
> Как в `jsonb` проверить, что первое значение содержит второе?

Оператор `@>` работает и на вложенных объектах:

```sql
'{"a":1, "b":2}'::jsonb @> '{"b":2}'::jsonb -- t
'{"a":{"b":{c:1}}'::jsonb @>'{"a":{"b":{}}}'::jsonb -- t
```

---
> Как отформатировать вывод столбца типа `jsonb`?

Функция `jsonb_pretty()`:

```sql
SELECT s.name, jsonb_pretty(sd.details_b) FROM ...
```

---
> Что делает функция `jsonb_each()`?

Разворачивает JSON-объект верхнего уровня в последовательность пар "ключ-значение"

---
> Что такое SQL/MED? Как реализуется в Postgres?

Это стандарт ISO/IEC9075-9 (Management of External Data) по работе в SQL с внешними источниками информации - как правило, другими СУБД (напр., MySQL)

Реализуется через специальные обертки. Создаются таблицы (foreign table), которые сами не содержат данных, а перенаправляют все обращения к внешнему источнику. Используются команды

```sql
CREATE FOREIGN DATA WRAPPER
CREATE SERVER
CREATE USER MAPPING
CREATE FOREIGN TABLE
IMPORT FOREIGN SCHEMA
```

---
> Как просмотреть список всех доступных расширений?

Он находится в таблице `pg_available_extensions`:

```sql
SELECT * FROM pg_available_extensions
```

---
> Как установить расширение?

Например, для создания foreign table и связи с MySQL или другим экземпляром себя же:

```sql
CREATE EXTENSION mysql_fdw;
CREATE EXTENSION postgres_fdw;
```

Второе расширение и создаваемые на его основе внешние таблицы являются встроенным в PostgreSQL механизмом *шардинга*

---

# Среда и командная строка [env]

---
> Как изменить значение конфигурационного параметра?

Отредактировать файл `/etc/postgresql/12/main/postgresql.conf` и перезагрузить настройки - например, выполнить от пользователя `postgres`

```sql
SELECT pg_reload_conf()
```

---
> Как узнать значение конфигурационного параметра?

Командой `SHOW`:

```sql
SHOW shared_buffers
```

```shell
 shared_buffers 
----------------
 128MB
(1 row)
```

---
> Как создать базу из дампа?

Перенаправить вывод, список SQL-команд на вход клиента, `psql`. Или воспользоваться его же опцей `-f`:

```shell
$ cat dump.sql | psql
$ psql < dump.sql
$ psql [-d <db-name>] -f dump.sql
```

При этом `sudo -u <user> psql` будет определять, от имени какого юзера выполняется заливка дампа, а `psql -U <user>` скажет, какому станет принадлежать создаваемая база

---
> Как создать нового пользователя?

От имени суперпользователя (`postgres`):

```sql
CREATE USER <user> PASSWORD '...'
```

---
> Как создать базу данных для другого пользователя?

С ключевым словом `OWNER`:

```sql
CREATE DATABASE <db-name> OWNER <user>
```

Обычно выполняется от суперпользователя (`postgres`), чтобы хватил прав

---
> Какая библиотека является системным драйвером PostgreSQL?

Устанавливается apt-ом по умолчанию, идет в стандартной поставке:

```shell
libpq
```

Написана на C

---
> Как заставить сервер перечитать настройки конфигурационных файлов?

```sql
SELECT pg_reload_conf()
```

Или из командной строки

```shell
$ sudo service postgresql reload|restart
```

---
> Что значит метод аутентификации `md5`?

В отличие от `peer`/`trust`, это уже требование на ввод пароля пользователем вручную

---
> Что значит метод аутентификации `peer`?

Означает, что PostgreSQL запрашивает имя текущего пользователя у операционной системы и считает, что ОС уже выполнила необходимую проверку (спросила у пользователя пароль.  Поэтому пользователю обычно не приходится вводить пароль при подключении к серверу на своем компьютере: достаточно того, что пароль был введен при входе в систему

---
> Какой формат у конфигурационного файла `pg_hba.conf`?

Строки разбиты на пять столбцов:

```shell
# TYPE  DATABASE  USER  ADDRESS       METHOD
local   all       all                 peer
```

Строка из примера выше читается как "локальные соединения (local) к любой базе (all) под любым пользователем (all) должны проверяться методом `peer`". IP-адрес для локальных соединений не указывается

---
> Как называются два основных файла настроек?

```shell
postgresql.conf
pg_hba.conf
```

Оба хранятся в папке `etc/postgresql/12/main/` (версия, естественно, может меняться)

---
> Какой формат по дефолту имеет строка приглашения в интерактивном терминале?

Имя текущей базы + `=` + решетка для суперпользователя или символ "больше" для обычного:

```shell
postgres=#
localhost=>
```

---
> Какой порт использует PostgreSQL по дефолту?

```shell
5432
```

Только на моей Ubuntu он почему-то `5433`

---
> Как в интерактивном терминале подключиться к базе от имени другого пользователя?

Так же, но после имени базы указать имя пользователя:

```shell
# \c <db-name> <user>
```

В конце можно также указать имя хоста и порт

---
> Как переподключиться к текущей базе?

Та же команда, но без аргумента:

```shell
# \c
```
Это бывает нужно для того, чтобы настройки применились после изменений

---
> Как создать полную "двоичную" резервнубю копию кластера СУБД?

Сохранит в каталоге `<backup>`:

```shell
$ pg_basebackup -D <backup>
```

---
> Какая команда создает дамп базы?

Вторая команда сохраняет все базы, а также пользователейи табличные пространства:

```shell
$ pg_dump <db-name>|$PGDATABASE [> dump.sql]
; pg_dumpall [-f/--file=...]
```

Выводит в `stdout` SQL-команды. Если переменная среды `PGDATABASE` не задана, дампит дефолтную базу (совпадающую с именем текущего пользователя)

---
> Как выйти из интерактивного терминала?

```shell
# \q
```

---
> Как в интерактивном терминале включить/выключить отображение времени выполнения команд?

После этого самой нижней строкой будет отображаться `Time: N ms`:

```shell
# \timing [on|off]
```

По умолчанию выключено. Без опции переключает между значениями

---
> Как в интерактивном терминале сменить режим отображения на расширенный (построчный)?

По умолчанию такой режим отключен (`off`):

```shell
# \x [on|off|auto]
```

Без опций переключает между `on`/`off`. Опция `auto` выводит результаты по строкам только когда они не влезают в экран

---
> Чувствительна ли Postgres к регистру?

Backslash-команды да, а SQL-запросы нет, и это касается не только ключевых слов, но и имен таблиц/столбцов/etc.

---
> Как в текущей базе вывести список всех таблиц?

```shell
# \d[S+]
```

С невыбранной базой будет ошибка `Did not find any relations.`

---
> Как вывести описание таблицы?

```shell
# \d[S+] <имя-таблицы>
```

Выводит столбцы построчно:

```shell
test=# \d students
 s_id       | integer |           | not null | 
 name       | text    |           |          | 
 start_year | integer |           |          |
```

Вообще, `# \d <name>` отображает информацию для любого объекта СУБД

---
> Как отображает неопределенное значение в интерактивном терминале?

Никак, `NULL` в результатах выборок не отображается, вместо него пустая строка:

```sql
SELECT NULL;
```

```shell
 ?column? 
----------
 
(1 row)
```

---
> Какой короткий вариант у опции командной строки `--help`?

Знак вопроса:

```shell
-?
```

Стоит помнить, что стандартное `-h` относится к другой опции - `--host=`

Кроме того, с короткой опцией нельзя получить справку по backslash-командам и переменным, они доступны лишь с длинным именем опции:

```shell
--help=commands
--help=variables
```

---
> Как из командной строки выполнить инструкции из `.sql`-файла?

Опция `-f|--file=`:

```shell
$ psql -f dump.sql
```

---
> Как изменяется приглашение интерактивного терминала в строках продолжения?

Добавляется открывающая скобка перед символом решетки:

```shell
test=# CREATE TABLE courses(
test(#
```

---
> Как и от какого пользователя запускается консольный клиент?

От пользователя `postgres`:

```shell
$ sudo -u postgres psql
```

Произойдет переход в интерактивный режим СУБД с дефолтным prompt-ом `postgres=#`

---
> Как вывести список всех баз данных?

Команда `# \l`

---
> Как в информационных backslash-командах вывести дополнительную информацию?

Указать после команды `S` (системные объекты; опция есть для примерно половины команд) и/или `+` (доп. детали; опция есть почти для всех):

```shell
# \l+
# \dnS
```

---
> Как получить справку по backslash-командам?

Из командной строки:

```shell
$ psql --help=commands
```

или в интерактивном терминале (дефолтный режим справки):

```shell
# \?
```

Второй не стоит путать с `\h` - тот выводит справку по SQL-командам

---
> Какой пейджер используется в интерактивном терминале?

Системный, `more` или `less`

---
> Как в в интерактивном терминале переключиться на определенную базу данных?

Команда `c`:

```shell
# \c[onnect] <db>[<additional-info>]
```

Строка приглашения после этого поменяется с дефолтного `postgres=#` на `<db-name>=#`

---
> Как получить справку по опциям командной строки?

Из командной строки (дефолтный режим справки):

```shell
$ psql --help
$ psql --help=options
```

или в интерактивном терминале:

```shell
# \? options
```

---
> Как в интерактивном терминале получить справку по SQL-команде?

Без имени команды перечислит все, для которых доступна справка:

```shell
# \h[elp] <command>
# \help CREATE TABLE
# \h
```

Не стоит путать с `\?` - тот выводит справку по backslash-командам
